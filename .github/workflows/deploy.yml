name: Deploy DebateFin

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy-streamlit:
    name: Deploy to Streamlit Cloud
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Lint with flake8
        continue-on-error: true
        run: |
          pip install flake8
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
      
      - name: Test imports
        run: |
          python -c "import streamlit; import langchain_openai; import langgraph; print('All imports successful')"
      
      - name: Deploy to Streamlit Cloud
        env:
          STREAMLIT_CLOUD_API_KEY: ${{ secrets.STREAMLIT_CLOUD_API_KEY }}
        run: |
          echo "Streamlit Cloud deployment should be configured via Streamlit Cloud dashboard"
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref_name }}"

  deploy-heroku:
    name: Deploy to Heroku
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Login to Heroku
        uses: akhileshns/heroku-deploy@v3.12.12
        with:
          heroku_api_key: ${{ secrets.HEROKU_API_KEY }}
          heroku_app_name: ${{ secrets.HEROKU_APP_NAME }}
          heroku_email: ${{ secrets.HEROKU_EMAIL }}
          appdir: "."
          healthcheck: "https://${{ secrets.HEROKU_APP_NAME }}.herokuapp.com/_stcore/health"
          check_health: true
          usedocker: true
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          REDIS_URL: ${{ secrets.REDIS_URL }}
          WIND_API_KEY: ${{ secrets.WIND_API_KEY }}

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Test imports
        run: |
          python -c "
          import sys
          try:
              import streamlit
              import langchain_openai
              import langgraph
              import yfinance
              import torch
              print('✅ All core imports successful')
          except ImportError as e:
              print(f'❌ Import error: {e}')
              sys.exit(1)
          "
      
      - name: Test module loading
        run: |
          python -c "
          import sys
          sys.path.insert(0, '.')
          try:
              from tools import fetch_stock_data, calculate_financial_metrics
              from models import LSTMGrowthPredictor
              from cache_utils import cached_with_retry
              from hallucination_checker import HallucinationChecker
              print('✅ All modules loaded successfully')
          except Exception as e:
              print(f'❌ Module loading error: {e}')
              import traceback
              traceback.print_exc()
              sys.exit(1)
          "

